<!DOCTYPE html>
<head>
    <!-- Use correct character set. -->
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
    <link rel="stylesheet" href="css/demo.css" type="text/css">
</head>
<body>
<div id="map"></div>
<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
<script src="js/demo.js"></script>
<script>
    var vec_w = getWmsLayer("light");
    var geoBounds = [70, 15, 140, 60];
    var bounds = ol.proj.transformExtent(geoBounds, 'EPSG:4326',"EPSG:3857");
    map = new ol.Map({
        controls: ol.control.defaults({
            attribution: false
        }),
        target: 'map',
        layers: [vec_w],
        view: new ol.View({
            center: ol.proj.fromLonLat([98.633, 31.607]),
            zoom:4,
            minZoom:0,
            maxZoom:18
        })
    });
    var imageLayer = new ol.layer.Image({
        source: null,
        opacity: 0.5
    });
    map.addLayer(imageLayer);
    
    function getPalette() {
        var canvas = document.createElement("canvas");
        var ctx = canvas.getContext('2d');
        var gradient = ctx.createLinearGradient(0, 0, 0, 256);
        var grad = {
            0.2: '#0000ff',
            0.4: '#00ffff',
            0.6: '#00ff00',
            0.8: '#ffff00',
            1.0: '#ff0000'
        };
        for (var i in grad) {
            gradient.addColorStop(+i, grad[i]);
        }
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 1, 256);
        return ctx.getImageData(0,0,1,256).data;
    }

    var palette = getPalette();

    var img = new Image();
    img.src = 'css/ws_china.png';
    img.onload = function () {
        var width = img.width,
          height = img.height;
        
        var _canvas = document.createElement('canvas');
        _canvas.height = height;
        _canvas.width = width;
        var ctx = _canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        imgPixels = ctx.getImageData(0, 0, width, height);
    
        var canvas = document.createElement('canvas');
        canvas.height = height;
        canvas.width = width;
        document.body.appendChild(canvas);
        var context = canvas.getContext("2d"),
          image = context.createImageData(width, height);
        
        var data = {
            data: [],
            max: -999,
            min: 999
        };
        for(var j = 0;j<height;j++){
            for(var i = 0;i<width;i++){
                var _ji = (j * 4) * width + i * 4;
                var r = imgPixels.data[_ji],
                  g = imgPixels.data[_ji+1] ,
                  b = imgPixels.data[_ji+2];
                var val = r * 256 + g + b * 0.01;
                val = parseFloat(val.toFixed(3));
                data.data.push(val);
                data.max = data.max < val ? val: data.max;
                data.min = data.min > val ? val: data.min;
            }
        }
        //更新图片数据
        for (var j = 0; j < height; j++) {
            for (var i = 0; i < width; i++) {
                var k = j * width + i;
                var val = data.data[k];
                var radio =(val - data.min) / (data.max - data.min);
                image.data[4 * k] = palette[Math.floor(radio*255+1)*4-4];
                image.data[4 * k + 1] = palette[Math.floor(radio*255+1)*4-3];
                image.data[4 * k + 2] = palette[Math.floor(radio*255+1)*4-2];
                image.data[4 * k + 3] = val === 0 ? 0 : 255;
            }
        }
        context.putImageData(image, 0, 0);
        var source = new ol.source.ImageStatic({
            url: canvas.toDataURL("image/png"),
            imageExtent: bounds
        });
        imageLayer.setSource(source);
    };
</script>
</body>
